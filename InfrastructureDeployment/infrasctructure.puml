@startuml
!define C4P https://raw.githubusercontent.com/plantuml-stdlib/C4-PlantUML/master
!include C4P/C4_Deployment.puml

' Цвета для группировки
!define CLOUD_NODE #E6F7FF
!define ONPREM_NODE #FFF2E6
!define EXTERNAL_SERVICE #F0F0F0

title Deployment Diagram: Система Управления Лояльностью

' Облачный провайдер
Deployment_Node(cloud, "Облачный провайдер", "AWS / Yandex.Cloud", CLOUD_NODE) {
    
    ' Зона доступности 1
    Deployment_Node(zone1, "Зона доступности A", "", CLOUD_NODE) {
        
        ' K8s кластер
        Deployment_Node(k8s, "Kubernetes Cluster", "Managed K8s (EKS/GKE)", CLOUD_NODE) {
            
            ' Ingress и шлюзы
            Container(ingress, "Ingress Controller", "Nginx Ingress", "Маршрутизация входящего трафика, SSL терминация")
            
            ' Микросервисы (подами)
            Deployment_Node(backend_pods, "Backend Pods", "", CLOUD_NODE) {
                Container(auth_pod, "Auth Service", "Java, Docker", "3 реплики")
                Container(client_pod, "Client Service", "Java, Docker", "3 реплики")
                Container(loyalty_pod, "Loyalty Core", "Java, Docker", "4 реплики (высокая нагрузка)")
                Container(campaign_pod, "Campaign Service", "Java, Docker", "2 реплики")
                Container(analytics_pod, "Analytics Service", "Java, Docker", "2 реплики")
                Container(notify_pod, "Notification Service", "Java, Docker", "2 реплики")
            }
            
            ' Веб и мобильный бэкенд
            Deployment_Node(app_pods, "Application Pods", "", CLOUD_NODE) {
                Container(webapp_pod, "Web Application", "Java + Nginx, Docker", "2 реплики")
                Container(mobile_api_pod, "Mobile API Gateway", "Java, Docker", "3 реплики")
            }
            
            ' Кэши и очереди в K8s
            Deployment_Node(data_pods, "Data Services in K8s", "", CLOUD_NODE) {
                Container(redis_pod, "Redis Cache", "Redis, Docker", "Мастер + 2 реплики")
                Container(kafka_pod, "Kafka Broker", "Kafka, Docker", "3 брокера")
            }
        }
        
        ' Управляемые базы данных (вне K8s)
        Deployment_Node(managed_db, "Managed Databases", "", CLOUD_NODE) {
            ContainerDb(loyalty_db, "Loyalty PostgreSQL", "PostgreSQL 14", "Primary instance\n16GB RAM, 4 vCPU")
            ContainerDb(analytics_db, "Analytics ClickHouse", "ClickHouse", "Аналитический кластер")
        }
    }
    
    ' Зона доступности 2 (для отказоустойчивости)
    Deployment_Node(zone2, "Зона доступности B", "", CLOUD_NODE) {
        ContainerDb(loyalty_replica, "PostgreSQL Replica", "PostgreSQL 14", "Read replica\nСинхронная репликация")
    }
    
    ' CDN и хранилища
    Deployment_Node(storage, "CDN & Object Storage", "", CLOUD_NODE) {
        Container(cdn, "CDN", "CloudFront / Cloud CDN", "Раздача статики мобильного приложения")
        Container(s3, "Object Storage", "S3 / Object Storage", "Статика web-приложения, логи, бэкапы")
    }
    
    ' Мониторинг и логи
    Deployment_Node(monitoring, "Мониторинг", "", CLOUD_NODE) {
        Container(prometheus, "Prometheus", "Сбор метрик", "Мониторинг сервисов")
        Container(grafana, "Grafana", "Дашборды", "Визуализация метрик")
        Container(loki, "Loki", "Сбор логов", "Агрегация логов")
    }
}

' On-premise часть (магазины/офисы)
Deployment_Node(onprem, "Магазины / Офисы", "Локальная инфраструктура", ONPREM_NODE) {
    Deployment_Node(store, "Магазин 1", "", ONPREM_NODE) {
        Container(pos1, "POS-терминал", "Windows/Linux", "Кассовая система")
    }
    
    Deployment_Node(office, "Центральный офис", "", ONPREM_NODE) {
        Container(crm_server, "CRM Сервер", "Windows Server", "Локальная CRM")
        Container(admin_pc, "Рабочая станция", "Windows/Mac", "Администратор / Менеджер")
    }
}

' Внешние системы и пользователи
Deployment_Node(internet, "Интернет", "", EXTERNAL_SERVICE) {
    Container(user_mobile, "Мобильное приложение", "React Native", "Устанавливается из AppStore/GooglePlay")
    Container(user_browser, "Web Browser", "Chrome/Firefox/Safari", "Доступ к web-интерфейсу")
}

' Внешние сервисы
Deployment_Node(external, "Внешние SaaS сервисы", "", EXTERNAL_SERVICE) {
    Container(payment_gw, "Платежный шлюз", "CloudPayments / YooKassa", "Облачный API")
    Container(email_service, "Email Service", "SendGrid / Mailgun", "SMTP/API")
    Container(sms_service, "SMS Gateway", "SMS.ru / Twilio", "HTTP API")
}

' --- КРИТИЧЕСКИЕ СВЯЗИ ---

' Входящий трафик от пользователей
Rel(user_mobile, cdn, "Загружает статику приложения", "HTTPS (443)")
Rel(user_browser, ingress, "Доступ к web-интерфейсу", "HTTPS (443)")
Rel(user_mobile, mobile_api_pod, "API вызовы", "HTTPS (443)")

' Внутренние связи в K8s
Rel(ingress, webapp_pod, "Перенаправляет web-трафик", "HTTP (80)")
Rel(ingress, mobile_api_pod, "Перенаправляет API трафик", "HTTP (80)")
Rel(mobile_api_pod, auth_pod, "Аутентификация запросов", "HTTP")
Rel(mobile_api_pod, client_pod, "Запрос данных клиента", "HTTP")
Rel(auth_pod, redis_pod, "Кэширует сессии", "Redis protocol")
Rel(loyalty_pod, kafka_pod, "Публикует события транзакций", "Kafka protocol")
Rel(analytics_pod, kafka_pod, "Читает события для анализа", "Kafka protocol")
Rel(analytics_pod, analytics_db, "Записывает агрегированные данные", "ClickHouse protocol")

' Связи с базами данных
Rel(auth_pod, loyalty_db, "Читает/пишет учетные данные", "PostgreSQL (5432)")
Rel(client_pod, loyalty_db, "Управляет профилями клиентов", "PostgreSQL (5432)")
Rel(loyalty_pod, loyalty_db, "Обрабатывает транзакции, балансы", "PostgreSQL (5432)")
Rel(loyalty_db, loyalty_replica, "Синхронная репликация", "PostgreSQL streaming")

' Связи с on-premise инфраструктурой
Rel(pos1, loyalty_pod, "Отправляет чеки для начисления баллов", "HTTPS / VPN")
Rel(loyalty_pod, crm_server, "Синхронизация данных клиента", "HTTPS / VPN")

' Связи с внешними сервисами
Rel(loyalty_pod, payment_gw, "Инициация платежей", "HTTPS (443)")
Rel(notify_pod, email_service, "Отправка email", "SMTP/API")
Rel(notify_pod, sms_service, "Отправка SMS", "HTTP API")

' Мониторинг
Rel(prometheus, backend_pods, "Собирает метрики", "HTTP")
Rel(backend_pods, loki, "Отправляет логи", "HTTP")

' Резервное копирование
Rel(loyalty_db, s3, "Ежедневные бэкапы", "HTTPS")
Rel(analytics_db, s3, "Архивация старых данных", "HTTPS")

' Горизонтальные связи для лучшей компоновки
ingress -[hidden]down-> cloud
user_mobile -[hidden]right-> external

legend right
|<#E6F7FF> Облачная инфраструктура|
|<#FFF2E6> Локальная инфраструктура|
|<#F0F0F0> Внешние системы|
endlegend

@enduml