# ADR: 2025-12.4  
## Анализ архитектурных паттернов для системы управления лояльностью клиентов

**Дата:** 13 декабря 2025 г.  
**Статус:** Принято

---

## Контекст

Для удовлетворения нефункциональных требований по:

- **производительности** (PER01–PER04),
- **масштабируемости** (SCA01–SCA05),
- **доступности** (AVA01),
- **надёжности** (DUR01–DUR03)

Системы управления лояльностью клиентов необходимо проанализировать и применить
соответствующие архитектурные паттерны.

Анализ проводится в рамках утверждённой архитектуры **модульного монолита**
на базе **Kotlin / Spring Boot** с учётом планового роста нагрузки
до **250 000 пользователей**.

---

## Рассмотренные паттерны

- Трёхзвенная структура  
- Кеширование и проблема инвалидации кеша  
- Толстый клиент  
- Деградация функциональности  
- Масштабирование (горизонтальное, вертикальное, во времени)  
- SOA и монолит  
- Индексы в базе данных  
- Репликация  
- Вертикальный и горизонтальный шардинг  
- Партиционирование  
- Денормализация  
- Функциональное разделение  
- Отложенные вычисления  
- Асинхронная обработка  
- Конвейер  
- Параллельные выполнения  
- Event-Driven Architecture (EDA)

---

## Решение

Принято решение о применении **комбинации архитектурных паттернов**
в различных компонентах модульного монолита:

- **Просмотр баланса и акций**  
  Кеширование + индексы + репликация на чтение

- **Начисление и списание баллов**  
  Асинхронная обработка (события) + партиционирование истории

- **Аналитика и отчёты**  
  Отложенные вычисления + денормализация витрин данных

- **Уведомления**  
  Конвейер событий + асинхронная обработка

- **Ядро системы**  
  Трёхзвенная структура модулей + вертикальное и горизонтальное масштабирование приложения

- **Архитектурный стиль**  
  Модульный монолит с чёткими границами контекстов + Event-Driven взаимодействие

---

## Обоснование

### 1. Трёхзвенная структура

**Применение:**  
Базовая архитектура каждого модуля (Loyalty, Promotion, Analytics).

**Решаемые требования:** PER01, SCA01, DUR01

**Компоненты:**  
Controller → Service → Repository

**Плюсы:**
- Чёткое разделение ответственности
- Упрощение тестирования и сопровождения
- Повторное использование бизнес-логики

**Минусы:**
- Дополнительные накладные расходы на межслойное взаимодействие
- Риск размывания границ слоёв при отсутствии архитектурного контроля

---

### 2. Кеширование и проблема инвалидации кеша

**Применение:**  
Redis для кеширования активных акций (F05), правил начисления (F10),
балансов топ-клиентов (F12).

**Решаемые требования:** PER01, PER02, SCA01

**Стратегия инвалидации:**  
TTL 5 минут + принудительная инвалидация по событию изменения из админки

**Плюсы:**
- Существенное сокращение времени отклика
- Снижение нагрузки на базу данных
- Устойчивость к всплескам трафика

**Минусы:**
- Сложность поддержания согласованности данных
- Необходимость отдельной инфраструктуры (Redis)

---

### 3. Толстый клиент

**Применение:** Не применяется.

**Причина отказа:**  
Противоречит PRN04 (User-Centric Design) и требованию поддержки браузеров (PLT01).

**Минусы:**
- Усложнение обновлений клиента
- Риски безопасности
- Перенос бизнес-логики на недоверенную сторону

---

### 4. Деградация функциональности

**Применение:**  
Модуль начисления баллов (F03). При сбое CRM или сервиса уведомлений
баллы начисляются, а синхронизация и оповещение ставятся в очередь.

**Решаемые требования:** AVA01, DUR01

**Плюсы:**
- Сохранение работоспособности ключевых функций
- Повышение доступности системы

**Минусы:**
- Eventual Consistency
- Усложнение логики повторных попыток

---

### 5. Масштабирование

**Горизонтальное:**  
Добавление инстансов приложения за балансировщиком нагрузки (с этапа SCA04)

**Вертикальное:**  
Увеличение ресурсов сервера БД (SCA02–SCA03)

**Во времени:**  
Генерация сложных отчётов (F07) в ночное время (AVA02)

**Решаемые требования:** SCA01–SCA05, PER04

**Плюсы:**
- Гибкость масштабирования
- Повышение отказоустойчивости

**Минусы:**
- Сложность управления состоянием при scaling out

---

### 6. SOA и монолит

**Применение:**  
Выбран модульный монолит на Kotlin/Spring Boot.
SOA (микросервисы) отложена до этапа SCA05.

**Решаемые требования:** SCA01, SCA02, PRN03

**Плюсы монолита:**
- Низкая операционная сложность
- ACID-транзакции
- Высокая производительность межмодульных вызовов

**Минусы монолита:**
- Единый цикл релиза
- Риск скрытых зависимостей между модулями

---

### 7. Индексы в базе данных

**Применение:**  
PostgreSQL. Составные индексы:
- `(user_id, created_at)` — история операций (F06)
- `(status, end_date)` — акции (F05)

**Решаемые требования:** PER02, PER03

**Плюсы:**
- Ускорение запросов на порядки

**Минусы:**
- Замедление операций записи
- Дополнительное дисковое пространство

---

### 8. Репликация

**Применение:**  
1 мастер + 2 реплики PostgreSQL для операций чтения.

**Решаемые требования:** AVA01, DUR02, DUR03

**Плюсы:**
- Повышение доступности
- Распределение нагрузки на чтение

**Минусы:**
- Задержка репликации
- Усложнение администрирования

---

### 9. Шардинг

**Вертикальный:**  
Естественное разделение по модулям в рамках одной БД.

**Горизонтальный:**  
Рассматривается для таблицы `transactions` на этапе SCA05.

**Решаемые требования:** SCA04, SCA05

**Плюсы:**
- Потенциально неограниченное масштабирование

**Минусы:**
- Сложность кросс-шардовых запросов

---

### 10. Партиционирование

**Применение:**  
Таблица `transactions`, partition by range (created_at), по месяцам.

**Решаемые требования:** PER04, SCA01

**Плюсы:**
- Быстрые запросы к историческим данным
- Упрощение удаления старых записей

**Минусы:**
- Сложность запросов по нескольким партициям

---

### 11. Денормализация

**Применение:**  
Аналитические витрины для отчётов (F07).

**Решаемые требования:** PER03

**Плюсы:**
- Минимизация JOIN
- Высокая скорость чтения

**Минусы:**
- Избыточность данных
- Сложность обновлений

---

### 12. Функциональное разделение

**Применение:**  
Модули: loyalty-core, promotion-engine, notification-service, analytics-module.

**Решаемые требования:** PRN03, SCA01

**Плюсы:**
- Чёткие границы ответственности
- Подготовка к возможной декомпозиции

**Минусы:**
- Требует строгой архитектурной дисциплины

---

### 13. Отложенные вычисления

**Применение:**  
Расчёт аналитики и персональных предложений.

**Решаемые требования:** PER04, SCA01

**Плюсы:**
- Снижение пиковой нагрузки

**Минусы:**
- Неактуальность данных в реальном времени

---

### 14. Асинхронная обработка

**Применение:**  
Уведомления (F11), аудит-лог (SEC04), интеграции (F09).

**Решаемые требования:** PER01, PER03, SCA01

**Плюсы:**
- Неблокирующая обработка
- Повышение пропускной способности

**Минусы:**
- Сложность отслеживания статуса операций

---

### 15. Конвейер

**Применение:**  
Обработка событий покупок из POS/ERP (F09).

**Решаемые требования:** PER02, SCA01

**Этапы:**  
Валидация → обогащение → применение правил → начисление баллов

**Плюсы:**
- Параллельная обработка
- Хорошая масштабируемость

**Минусы:**
- Сложность управления стадиями

---

### 16. Параллельные выполнения

**Применение:**  
Analytics — параллельный расчёт сегментов отчётов.

**Решаемые требования:** PER03, PER04

**Реализация:** Kotlin Coroutines

**Плюсы:**
- Эффективное использование CPU

**Минусы:**
- Сложность синхронизации

---

### 17. Event-Driven Architecture (EDA)

**Применение:**  
Взаимодействие между модулями монолита.

**События:**  
BonusAccrued, BonusSpent, PromotionActivated

**Решаемые требования:** PRN03, SCA01

**Плюсы:**
- Слабая связанность модулей
- Подготовка к масштабированию

**Минусы:**
- Повышенные требования к мониторингу

---

## Последствия

### Технические
- Монолит требует строгого соблюдения модульных границ
- Необходим комплексный мониторинг (MON01)

### Операционные
- Проще развёртывание
- Ограниченная гибкость масштабирования по сравнению с микросервисами

### Бизнес
- Готовность к росту до 100k пользователей
- Высокая доступность и предсказуемая производительность

---

## Рекомендации по реализации

- Начать с: трёхзвенной структуры, индексов, асинхронной отправки уведомлений
- Внедрить кеширование и репликацию БД сразу после запуска
- Партиционирование `transactions` — при приближении к 1 млн записей
- Каждое решение сопровождать метриками (MON01)
