ADR: 2025-12.4 - Анализ архитектурных паттернов для системы управления лояльностью клиентов

Дата: 13 декабря 2025 г.
Статус: Принято

Контекст:
Для удовлетворения нефункциональных требований по производительности (PER01-PER04), масштабируемости (SCA01-SCA05), доступности (AVA01) и надежности (DUR01-DUR03) Системы управления лояльностью клиентов необходимо проанализировать и применить соответствующие архитектурные паттерны. Анализ проводится в рамках утверждённой архитектуры модульного монолита на Kotlin/Spring Boot с учётом планового роста до 250 000 пользователей.

Рассмотренные паттерны:

Трехзвенная структура

Кеширование и проблема инвалидации кеша

Толстый клиент

Деградация функциональности

Масштабирование (горизонтальное, вертикальное, во времени)

SOA и монолит

Индексы в базе данных

Репликация

Вертикальный и горизонтальный шардинг

Партиционирование

Денормализация

Функциональное разделение

Отложенные вычисления

Асинхронная обработка

Конвейер

Параллельные выполнения

Event-Driven Architecture (EDA)

Решение:
Применение комбинации паттернов в различных компонентах модульного монолита:

Просмотр баланса и акций: Кеширование + индексы + репликация на чтение

Начисление и списание баллов: Асинхронная обработка (события) + партиционирование истории

Аналитика и отчёты: Отложенные вычисления + денормализация витрин данных

Уведомления: Конвейер событий + асинхронная обработка

Ядро системы: Трехзвенная структура модулей + вертикальное/горизонтальное масштабирование приложения

Архитектурный стиль: Модульный монолит с чёткими границами контекстов + Event-Driven взаимодействие

Обоснование:

1. Трехзвенная структура
Применение: Базовая архитектура каждого модуля (Loyalty, Promotion, Analytics).

Решаемые требования: PER01, SCA01, DUR01.

Компоненты: Все модули (Controller → Service → Repository).

2. Кеширование и проблема инвалидации кеша
Применение: Redis для кеширования активных акций (F05), правил начисления (F10), балансов топ-клиентов (F12).

Решаемые требования: PER01, PER02, SCA01.

Стратегия инвалидации: TTL 5 минут + принудительная инвалидация по событию изменения из админки.

3. Толстый клиент
Применение: Не применяется, противоречит PRN04 (User-Centric Design) и требованию поддержки браузеров (PLT01).

4. Деградация функциональности
Применение: Модуль начисления баллов (F03). При сбое CRM или сервиса уведомлений баллы начисляются, а синхронизация и оповещение ставятся в очередь.

Решаемые требования: AVA01, DUR01.

5. Масштабирование
Горизонтальное: Добавление инстансов приложения за балансировщиком нагрузки (начиная с SCA04).

Вертикальное: Увеличение ресурсов для сервера БД на этапе SCA02-SCA03.

Во времени: Генерация сложных отчётов (F07) переносится на ночное время (AVA02).

Решаемые требования: SCA01-SCA05, PER04.

6. SOA и монолит
Применение: Выбран модульный монолит на Kotlin/Spring Boot. SOA (микросервисы) отложена до этапа SCA05.

Решаемые требования: SCA01, SCA02, PRN03 (модульность).

7. Индексы в базе данных
Применение: PostgreSQL. Составные индексы: (user_id, created_at) для истории операций (F06), (status, end_date) для акций (F05).

Решаемые требования: PER02, PER03.

8. Репликация
Применение: Настройка 1 мастер + 2 реплики для PostgreSQL. Реплики обслуживают запросы на чтение: историю (F06), отчёты (F07).

Решаемые требования: AVA01, DUR02, DUR03.

9. Шардинг
Вертикальный: Естественное разделение по модулям в рамках одной БД.

Горизонтальный: Не применяется на старте. Рассматривается для таблицы transactions на этапе SCA05.

Решаемые требования: SCA04, SCA05.

10. Партиционирование
Применение: Партиционирование таблицы transactions по диапазону дат (created_at), например, по месяцам.

Решаемые требования: PER04, SCA01.

11. Денормализация
Применение: Витрины данных для отчётов (F07). Агрегированные суммы рассчитываются ночью и хранятся отдельно.

Решаемые требования: PER03 (генерация отчётов < 5 сек).

12. Функциональное разделение
Применение: В рамках монолита: чёткие модули (loyalty-core, promotion-engine, notification-service, analytics-module).

Решаемые требования: PRN03 (модульность и расширяемость), SCA01.

13. Отложенные вычисления
Применение: Расчёт сложной аналитики (F07), формирование персональных предложений.

Решаемые требования: PER04, SCA01.

14. Асинхронная обработка
Применение: Отправка уведомлений (F11), запись в аудит-лог (SEC04), интеграционные вызовы к CRM/ERP (F09).

Решаемые требования: PER01, PER03, SCA01.

Реализация: Spring Events + @Async или Kafka.

15. Конвейер
Применение: Обработка входящего потока событий о покупках из POS/ERP (F09).

Решаемые требования: PER02, SCA01.

Этапы: Валидация → обогащение данными клиента → применение правил → начисление баллов.

16. Параллельные выполнения
Применение: Внутри модуля Analytics для параллельного расчёта разных сегментов отчёта.

Решаемые требования: PER03, PER04.

Реализация: Kotlin Coroutines.

17. Event-Driven Architecture (EDA)
Применение: Взаимодействие между модулями монолита. События: BonusAccrued, BonusSpent, PromotionActivated.

Решаемые требования: PRN03 (слабая связанность модулей), SCA01.

Последствия:

Технические: Монолит требует безупречного модульного разделения. Необходим комплексный мониторинг (MON01).

Операционные: Проще развёртывание, но сложнее независимого масштабирования по сравнению с микросервисами.

Для бизнеса: Система готова к росту до 100k пользователей с высокой отказоустойчивостью (AVA01).

Рекомендации по реализации:

Начать с паттернов: Трехзвенная структура, Индексы, Асинхронная обработка уведомлений.

Внедрить Кеширование и Репликацию БД сразу после запуска.

Партиционирование таблицы транзакций внедрить при приближении к 1 млн записей.

Каждое решение должно сопровождаться метриками (MON01).