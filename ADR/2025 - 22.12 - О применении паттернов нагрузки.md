# ADR: 2025-12.4  
## Анализ архитектурных паттернов для системы управления лояльностью клиентов

**Дата:** 13 декабря 2025 г.  
**Статус:** Принято

---

## Контекст

Для удовлетворения нефункциональных требований по:

- **Производительности** (PER01–PER04),
- **Масштабируемости** (SCA01–SCA05),
- **Доступности** (AVA01),
- **Надёжности** (DUR01–DUR03)

системы управления лояльностью клиентов необходимо проанализировать и применить архитектурные паттерны.

Система реализуется в виде **модульного монолита** на **Kotlin / Spring Boot** с планируемым ростом до **250 000 пользователей**.

---

## Рассмотренные архитектурные паттерны

- Трёхзвенная структура  
- Кеширование и инвалидация кеша  
- Толстый клиент  
- Деградация функциональности  
- Масштабирование (горизонтальное, вертикальное, во времени)  
- SOA и монолит  
- Индексы в базе данных  
- Репликация  
- Вертикальный и горизонтальный шардинг  
- Партиционирование  
- Денормализация  
- Функциональное разделение  
- Отложенные вычисления  
- Асинхронная обработка  
- Конвейер  
- Параллельные выполнения  
- Event-Driven Architecture (EDA)

---

## Архитектурное решение

### Применение паттернов по компонентам системы

| Компонент | Применяемые паттерны |
|---------|---------------------|
| Просмотр баланса и акций | Кеширование + Индексы + Репликация чтения |
| Начисление и списание баллов | Асинхронная обработка + Партиционирование |
| Аналитика и отчёты | Отложенные вычисления + Денормализация |
| Уведомления | Конвейер событий + Асинхронная обработка |
| Ядро системы | Трёхзвенная структура + Масштабирование |

**Архитектурный стиль:**  
Модульный монолит с чёткими границами контекстов и **Event-Driven взаимодействием между модулями**.

---

## Обоснование архитектурных паттернов

### 1. Трёхзвенная структура

**Применение:**  
Базовая архитектура каждого модуля (Loyalty, Promotion, Analytics).

**Компоненты:**  
Controller → Service → Repository

**Решаемые требования:** PER01, SCA01, DUR01

**Плюсы:**
- Чёткое разделение ответственности  
- Упрощение тестирования и поддержки  
- Хорошая читаемость кода  

**Минусы:**
- Дополнительные накладные расходы  
- Возможная избыточность для простых операций  

---

### 2. Кеширование и инвалидация кеша

**Применение:**  
Redis для кеширования активных акций (F05), правил начисления (F10), балансов топ-клиентов (F12).

**Решаемые требования:** PER01, PER02, SCA01

**Стратегия инвалидации:**  
TTL 5 минут + инвалидация по событию из админки.

**Плюсы:**
- Снижение нагрузки на БД  
- Значительное ускорение ответов API  

**Минусы:**
- Риск устаревших данных  
- Сложность управления инвалидацией  

---

### 3. Толстый клиент

**Применение:** Не применяется.

**Причина:**  
Противоречит PRN04 (User-Centric Design) и PLT01 (поддержка браузеров).

**Плюсы:**
- Снижение серверной нагрузки  

**Минусы:**
- Сложность обновлений  
- Зависимость от устройства пользователя  

---

### 4. Деградация функциональности

**Применение:**  
Модуль начисления баллов (F03).

**Сценарий:**  
При сбое CRM или уведомлений — начисление выполняется, синхронизация откладывается.

**Решаемые требования:** AVA01, DUR01

**Плюсы:**
- Сохранение ключевых бизнес-функций  
- Повышение доступности  

**Минусы:**
- Асинхронная консистентность  
- Дополнительная логика восстановления  

---

### 5. Масштабирование

**Типы:**
- **Горизонтальное:** добавление инстансов  
- **Вертикальное:** увеличение ресурсов БД  
- **Во времени:** ночные вычисления  

**Решаемые требования:** SCA01–SCA05, PER04

**Плюсы:**
- Гибкость роста  
- Оптимальное использование ресурсов  

**Минусы:**
- Сложность управления состоянием  
- Рост инфраструктурных затрат  

---

### 6. SOA и монолит

**Применение:**  
Модульный монолит, SOA отложена до SCA05.

**Решаемые требования:** SCA01, SCA02, PRN03

**Плюсы монолита:**
- Простота развертывания  
- Минимальные сетевые накладные расходы  

**Минусы:**
- Ограниченное независимое масштабирование  
- Более сложный переход к микросервисам  

---

### 7. Индексы в базе данных

**Применение:** PostgreSQL  
- `(user_id, created_at)` — история операций  
- `(status, end_date)` — акции  

**Решаемые требования:** PER02, PER03

**Плюсы:**
- Значительное ускорение запросов  
- Предсказуемая производительность  

**Минусы:**
- Замедление операций записи  
- Дополнительное потребление диска  

---

### 8. Репликация

**Применение:**  
1 мастер + 2 реплики PostgreSQL.

**Решаемые требования:** AVA01, DUR02, DUR03

**Плюсы:**
- Повышение доступности  
- Балансировка чтения  

**Минусы:**
- Задержки репликации  
- Усложнение мониторинга  

---

### 9. Шардинг

**Вертикальный:** по модулям  
**Горизонтальный:** планируется на SCA05

**Решаемые требования:** SCA04, SCA05

**Плюсы:**
- Масштабируемость  
- Изоляция нагрузки  

**Минусы:**
- Сложные распределённые запросы  
- Миграция данных  

---

### 10. Партиционирование

**Применение:**  
Таблица `transactions` по `created_at`.

**Решаемые требования:** PER04, SCA01

**Плюсы:**
- Быстрые запросы  
- Упрощение очистки данных  

**Минусы:**
- Сложность запросов к нескольким партициям  

---

### 11. Денормализация

**Применение:**  
Витрины данных для аналитики.

**Решаемые требования:** PER03

**Плюсы:**
- Быстрая генерация отчётов  

**Минусы:**
- Дублирование данных  
- Усложнение обновлений  

---

### 12. Функциональное разделение

**Применение:**  
Модули: `loyalty-core`, `promotion-engine`, `notification-service`, `analytics-module`.

**Решаемые требования:** PRN03, SCA01

**Плюсы:**
- Слабая связанность  
- Упрощение поддержки  

**Минусы:**
- Требует строгой дисциплины разработки  

---

### 13. Отложенные вычисления

**Применение:**  
Аналитика и персональные предложения.

**Решаемые требования:** PER04, SCA01

**Плюсы:**
- Снижение пиковой нагрузки  

**Минусы:**
- Неактуальность данных в реальном времени  

---

### 14. Асинхронная обработка

**Применение:**  
Уведомления, аудит, интеграции.

**Решаемые требования:** PER01, PER03, SCA01

**Плюсы:**
- Неблокирующая обработка  
- Отказоустойчивость  

**Минусы:**
- Сложность отладки  

---

### 15. Конвейер

**Применение:**  
Обработка событий покупок.

**Этапы:**  
Валидация → Обогащение → Применение правил → Начисление

**Плюсы:**
- Параллельность  
- Масштабируемость  

**Минусы:**
- Сложность управления стадиями  

---

### 16. Параллельные выполнения

**Применение:**  
Analytics-модуль.

**Реализация:** Kotlin Coroutines

**Плюсы:**
- Эффективное использование CPU  

**Минусы:**
- Риски синхронизации  

---

### 17. Event-Driven Architecture (EDA)

**Применение:**  
Взаимодействие между модулями.

**События:**  
`BonusAccrued`, `BonusSpent`, `PromotionActivated`

**Решаемые требования:** PRN03, SCA01

**Плюсы:**
- Слабая связанность  
- Подготовка к микросервисам  

**Минусы:**
- Сложность отладки  
- Требуется мониторинг событий  

---

## Последствия

### Технические
- Требуется строгое модульное разделение  
- Необходим комплексный мониторинг (MON01)

### Операционные
- Простота развертывания  
- Ограниченное независимое масштабирование

### Бизнес
- Готовность к росту до 100k+ пользователей  
- Высокая доступность системы

---

## Рекомендации по реализации

1. Начать с:
   - Трёхзвенной структуры  
   - Индексов  
   - Асинхронной обработки уведомлений  

2. Внедрить кеширование и репликацию БД после запуска.

3. Партиционирование таблицы `transactions` внедрить при приближении к 1 млн записей.

4. Каждое решение сопровождать метриками (MON01).
